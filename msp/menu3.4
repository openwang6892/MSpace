#!/data/data/com.termux/files/usr/bin/bash

func=${1:-}

clear # 清屏
alias echo='echo -e'

menu_dir="$(dirname "$0")"
color_file="$(dirname "$0")/colors.conf"
readme_file="$(dirname "$0")/README.md"

# 加载颜色变量
[ -f "$color_file" ] && source "$color_file" || read -p "颜色配置文件不存在，将会带来显示异常。按 Enter 继续..." input

printf "${CYAN}$0\n" # 输出脚本路径以调试

# 基础配置
ver=v3.4
update_date=2025年9月6日
source ~/.bashrc

# 加载变量
COLOR=$GOLD
filename=$(basename "$0")

# 选项16的名称变量
if command -v toilet >/dev/null 2>&1; then
    GC='text="${NAME:-}"; raw=$(toilet -f term "$text"); \
        awk -v str="$raw" -v RS="" -v ORS="" \
        "BEGIN{ \
            split(\"\033[31m \033[91m \033[33m \033[92m \033[36m \033[94m \033[35m\", c, \" \"); \
            for(i=1;i<=length(str);i++) \
                printf \"%s%s\033[0m\", c[((i-1)%7)+1], substr(str,i,1); \
            printf \"\n\" \
        }"'
else
    GC='printf "%s\n" "${NAME:-}"'
fi

# 如果名称为空就等于空格
if [ "$NAME" = "" ]; then
  NAME=""
fi

# 环境检查
[ -z "$TERMUX_VERSION" ] && {
    printf "${BR_RED}警告：非 Termux 环境，部分选项可能无法使用！按 Enter 继续…${N}\n" >&2
    read -r input
}

# 命令检查
pkg_list="curl wget toilet clang git nano jq"
ALL_INSTALLED=true
for p in $pkg_list; do
    if ! command -v "$p" >/dev/null 2>&1; then
        ALL_INSTALLED=false
        printf "${BR_RED}$p未安装，是否现在安装？[y/N]\n"
        read input
        if [ "$input" = "y" ]; then
            pkg install "$p" -y
        fi
    fi
done

# 补丁：检测命令是否存在的小工具
checker() { command -v "$1" >/dev/null || { printf "${RED}未安装 %s${N}\n" "$1"; exit 1; } ; }
log() { echo "$@"; }

#######################################################################

ai_api() {
  export TERM=xterm-256color          # 1. 告诉 glow 这是彩色终端
  export COLUMNS=$(tput cols)         # 2. 把当前宽度传给它
  curl -s https://api.siliconflow.cn/v1/chat/completions \
    -H "Authorization: Bearer <Token>" \
    -H "Content-Type: application/json" \
    -d "{\"model\":\"Qwen/QwQ-32B\",\"messages\":[{\"role\":\"user\",\"content\":\"$1\"}]}" \
  | jq -r '.choices[0].message.content' \
  | PAGER=cat glow -w "${COLUMNS}"    # 3. 再指定宽度
}

dev_tools() {
    read -p "请输入脚本路径（留空即此脚本）：" scr
    [ -z "$scr" ] && scr="$0"
    echo "1.复制脚本到sdcard"
    echo "2.查找脚本字符"
    echo "3.计算脚本精确大小"
    read -p "请输入选项：" input
    case $input in
        1) cp "$scr" /sdcard/ ;;
        2) printf "${CYAN}请输入要查找的指令关键字：${N}"
           read -r key
           grep -n --color=always "$key" "$scr" ;;
	3) printf '%s\n' "$(LC_ALL=C numfmt --to=iec --suffix=B --format='%.4f' < <(wc -c < "$scr"))" ;;
    esac
}

new_menu() {
    echo "1.每日60s新闻"
    echo "2.ai新闻"
    read -p "请输入选项：" new_choice
    case $new_choice in
        1) curl https://60s.viki.moe/v2/ai-news | jq ;;
        2) curl https://60s.viki.moe/v2/60s | jq ;;
    esac
}

# ASCII 艺术字
ascii_termux() {
    printf "${LIME}"
    cat <<\EOF
 _____
|_   _|__ _ __ _ __ ___  _   ___  __
  | |/ _ \ '__| '_ ` _ \| | | \ \/ /
  | |  __/ |  | | | | | | |_| |>  <
  |_|\___|_|  |_| |_| |_|\__,_/_/\_\
EOF
}

# menu设置
menu_settings() {
    echo "$menu_dir"
    echo "1.查看自述文件\n2.编辑自述文件\n3.列出配置目录\n4.添加文件到此目录\n5.查看颜色配置文件"
    read -p "请输入选项：" choice
    case $choice in
	1) checker glow; glow "$readme_file" ;;
	2) nano "$readme_file" ;;
	3) ls "$HOME/bin/menu" ;;
	4) read -p "请输入文件路径" file; mv "$file $menu_dir" ;;
	5) cat $color_file
    esac
}

# Termux 工具菜单
termux_tools() {
    echo "1.给当前会话添加唤醒锁"
    echo "2.恢复termux字体为原本字体"
    echo "3.提取顶部的ASCII字termux"
    echo "4.提取/编辑termux欢迎语"
    echo "5.重载termux设置"
    echo "6.编辑小键盘设置"
    echo "7.修改小键盘为方便形式"
    echo "8.安装x11-repo"
    read -p "请输入选项：" choice
    case $choice in
        1) termux-wake-lock && echo "唤醒锁已添加" ;;
        2) rm -f ~/.termux/font.ttf ~/.termux/colors.properties && termux-reload-settings ;;
        3) ascii_termux ;;
        4) path="$PREFIX/etc/motd" 
           read -p "提取[1]还是编辑[2]欢迎语？" sub
            case $sub in 1) cat "$path" ;; 2) nano "$path" ;; esac ;;
        5) termux-reload-settings ;;
        6) nano ~/.termux/termux.properties ;;
        7) cat > ~/.termux/termux.properties <<'EOF'
extra-keys=[["ESC","<",">","BACKSLASH","=","^","$","()","{}","[]","_"],["TAB","&",";","#","~","%","*","HOME","UP","END","PGUP"],["CTRL","ALT","@","QUOTE","-","+","|","LEFT","DOWN","RIGHT","PGDN"]]
EOF
          ;;

        8) pkg install x11-repo ;;
    esac
}

# ADB 菜单
adb_menu() {
    checker adb
    adb start-server &
    read -p "输入IP(例如192.168.0.1): " ip
    read -p "输入端口号(例如5555): " port
    adb connect "$ip:$port"
    sleep 1

    while true; do
        clear
        cat <<EOF
0. 退出
1. 输入文字
EOF
        read -p "请输入选项：" input
        case $input in
            0) break ;;
            1)
                read -r -p "输入的文字：" text
                text="${text#"${text%%[![:space:]]*}"}"
                text="${text%"${text##*[![:space:]]}"}"
                [[ -z $text ]] && { echo "输入为空，已取消"; continue; }
                b64=$(printf '%s' "$text" | base64 -w0)
                adb shell "base64 -d <<< '$b64' | xargs -0 input text"
                ;;
            *) echo "无效选项"; adb_menu ;;
        esac
    done
}

# 资源列表
res_list() {
    echo "1.SCP基金会  2.多邻国破解  3.Beyond音乐"
    read -p "请选择：" sub
    case $sub in
        1) termux-open "https://scp-wiki-cn.wikidot.com/" ;;
        2) read -p "1.蓝奏云  2.123云盘  请选择：" s
           case $s in
           1) termux-open "https://yxssp.lanzoui.com/b0q6iadi" ;;
           2) termux-open "https://www.123684.com/s/zy7dvd-DubKv" ;;
           3) termux-open "https://www.123684.com/s/zy7dvd-rubKv" ;;
        esac ;;
    esac
}

# 加解密工具
enc_tools() {
    read -p "请输入文件路径：" path
    read -p "GPG(1) 还是 shc(2) ？" choose
    case $choose in
        1) checker gpg; read -p "加密(1) 还是解密(2) ？" sub
           case $sub in
           1) gpg -c "$path" ;;
           2) gpg --decrypt "$path" > "${path%.gpg}" ;;
              esac ;;
        2) read -p "加密(1) 还是解密(2) ？" sub
           case $sub in
           1) checker shc; shc -f "$path" -o "$path.x"
              cp -f "$path.x" ~/storage/ && rm -f "$path.x"
              log "已保存至 ~/storage" ;;
           2) read -p "请输入要解密的文件：" file
              ./unshc.sh "$file" -o "$file" ;; esac ;;
    esac
}

# PRoot-Distro 菜单
proot_distro_menu() {
    checker proot-distro
    cat <<'EOF'
执行操作：
1.安装系统
2.登录系统
3.获取帮助
4.列出所有可用系统
EOF
    read -p "请输入选项：" choice
    case $choice in
        1) read -p "选择系统安装：" dis
           proot-distro install "$dis"; echo "安装完成" ;;
        2) read -p "输入已安装系统以登录：" dis
           proot-distro login "$dis" ;;
        3) proot-distro -h ;;
        4) proot-distro list ;;
    esac
}

hello() {
    ascii_termux

    printf "\t${MAGENTA}你好！"
    eval "$GC" # 加载开头名称变量
    printf "${LIME}===============================${COLOR}\n"
}

hello

########################################################################
# 主菜单
main_menu() {
    echo "0.termux功能菜单"
    echo "1.更换镜像源(建议先回车再选第三个清华源)"
    echo "2.启动 VNC 服务器"
    echo "3.ADB 菜单"
    echo "4.一键打包GKD订阅"
    echo "5.编辑.bashrc"
    printf "${BR_RED}6.已停用\n"
    printf "7.已停用${COLOR}\n"
    echo "8.提醒管理"
    printf "${BR_RED}9.已停用${COLOR}\n"
    echo "10.添加命令"
    echo "11.尝试调用 Tmoe 工具"
    echo "12.启动 Python 静态文件服务器"
    echo "13.加解密文件/脚本"
    echo "14.检查脚本是否有错"
    echo "15.使用base64编解码文本"
    echo "16.输入名称"
    echo "17.安装所有可用的 Shell 解释器"
    echo "18.IP地址信息查询"
    echo "19.Hitokoto 一言句子获取"
    echo "20.获取当前精确到纳秒的时间"
    echo "21.备份 Termux 数据"
    echo "22.部署 Shizuku 的 Rish"
    echo "23.手机 TTS 说话"
    echo "24.PRoot-Distro 管理菜单"
    echo "25.ASCII艺术字生成"
    echo "26.启动xfce4"
    printf "${ORANGE}"
    echo "a.公告"
    echo "b.备份此脚本及.bashrc"
    echo "c.复制此脚本内容到剪贴板"
    echo "e.编辑此脚本"
    echo "f.有趣的包"
    echo "g.小游戏"
    echo "u.更新此脚本"
    echo "p.前往发布页"
    echo "h.获取帮助"
    echo "m.此脚本相关设置"
    echo "r.更多资源"
    echo "dt.开发者工具"
    echo "ad.高级"
    printf "${OLIVE}new.各种新闻\n"
    echo "bing.查看必应每日图片"
    echo "ai.调用ai"
    printf "${RUST}*.退出\n"
    printf "${N}"
    printf "${LIME}===============================${N}\n"
    printf "${CYAN}请输入选项："
    read choice
    printf "${N}"
    # 功能
    case $choice in
        0) termux_tools ;;
        1) termux-change-repo ;;
        2) checker startvnc; startvnc ;;
        3) adb_menu ;;
        4) termux-open "https://wwse.lanzoub.com/iAbYD31kwlcf" ;;
        5) nano ~/.bashrc ;;
        6) echo "停用" ;;
        7) echo "停用" ;;
        8)
            cd ~/storage
            read -p "添加提醒[1]，查看提醒[2]，清空提醒[3]：" choose
            case $choose in
                1) read -p "请输入提醒：" input
                printf "%s: %s\n" "$(date '+%F %T')" "$input" >> remind.txt ;;
                2) [ -f remind.txt ] && cat remind.txt || log "暂无提醒" ;;
                3) > remind.txt && log "提醒已清空" ;;
            esac
            cd - >/dev/null ;;
        9) echo "已停用" ;;
        10)
            read -p "输入命令名称：" cmd
            read -p "输入要执行的内容：" run
            printf 'alias %s="%s"\n' "$cmd" "$run" >> ~/.bashrc
            . ~/.bashrc && log "已添加 alias $cmd" ;;
        11) bash -c "$(curl -L https://gitee.com/mo2/linux/raw/2/2)" ;;
        12)
            read -p "输入端口号（默认8000）：" port
            port=${port:-8000}
            read -p "输入服务器根路径（默认当前目录）：" path
            path=${path:-.}
            cd "$path" && python -m http.server "$port" ;;
        13) enc_tools ;;
        14)
            read -p "自我检查(1) 还是检查其他脚本(2) ：" choose
            case $choose in
                1) sh -n "$0" ;;
                2) read -p "输入脚本路径：" p; sh -n "$p" ;;
            esac
            echo "无输出即正常" ;;
        15)
            read -p "编码(1) 还是解码(2) ？" sub
            case $sub in
                1) read -p "请输入文本：" t; printf '%s' "$t" | base64 ;;
                2) read -p "请输入 base64 ：" t; printf '%s' "$t" | base64 -d ;;
            esac ;;
        16)
            echo "提示：名称含有空格会导致脚本报错"
            read -p "请输入一个名字：" name
            sed -i "1iNAME=$name" ~/.bashrc; . ~/.bashrc ;;
        17) pkg update && pkg install -y bash dash zsh fish tcsh mksh elvish ash ;;
        18)
            read -p "请输入IP地址（留空则使用本机IP）：" ip
            ip=${ip:-$(curl -s ip.sb)}
            curl -s "http://ip-api.com/json/$ip?fields=66842623&lang=zh-CN" | jq . ;;
        19)
            read -p "类别字母(默认随机)： " ctype
            read -p "要输出几句（默认1）： " cnt
            curl -s "https://international.v1.hitokoto.cn/?c=${ctype:-}&encode=json" | jq -r '"「 $ .hitokoto )」——《 $ .from )》"' ;;
        20) while :; do printf '\033[2J\033[H%s\n' "$(date '+%F %H:%M:%S.%3N.%6N.%9N')"
            done ;;
        21)
            read -p "备份(1) 还是恢复(2) 数据？ " sub
            case $sub in
                1) termux-backup ~/storage/shared/termux-backup.tar.gz ;;
                2) read -p "请输入备份文件路径： " p; termux-restore "$p" ;;
            esac ;;
        22)
            mkdir -p ~/.shizuku
            wget -q --show-progress -P /sdcard/Download "https://link9.cc/A5I3UP"
            mv -f /sdcard/Download/rish* ~/.shizuku/
            chmod +x ~/.shizuku/rish
            grep -q 'alias rish=' ~/.bashrc || echo 'alias rish="sh $HOME/.shizuku/rish"' >> ~/.bashrc ;;
        23) read -p "请输入要朗读的文字" input; termux-tts-speak "$input" ;;
        24) proot_distro_menu ;;
        25) checker figlet; read -p "请输入文字：" letter; printf "${VIOLET}"; figlet "$letter" ;;
        26) checker startxfce4; checker termux-x11-nightly
            export DISPLAY=:689; termux-x11 :689 &
            sleep 2; startxfce4 &
            am start -n com.termux.x11/.MainActivity ;;

######################################################################
        a|A)
            printf "${BR_GREEN}$update_date\n"
            cat <<EOF
无

更新日志$ver：
记不清了
其他修改
EOF
            printf "${N}" ;;
        b|B) 
            read -p "备份~/.bashrc请输入1，备份此脚本请输入2，全部备份请输入3：" input
            case $input in
                1) cp -f ~/.bashrc "$HOME/storage/shared/" && log "已备份 ~/.bashrc 到 /sdcard/" ;;
                2) cp -f "$0" "$HOME/storage/shared/" && log "已备份本脚本到 /sdcard/" ;;
                3) cp -f ~/.bashrc "$HOME/storage/shared/"; cp -f "$0" "$HOME/storage/shared/"; log "已全部备份到 /sdcard" ;;
            esac ;;
        c|C) 
            read -p "0.复制命令输出结果1.复制此脚本 2.复制.bashrc 3.自定义：" input
            case $input in
                0) read -p "请输入命令：" cmd; $cmd | termux-clipboard-set ;;
                1) cat $0 | termux-clipboard-set ;;
                2) cat ~/.bashrc | termux-clipboard-set ;;
                3) read -p "请输入路径：" path; cat $path | termux-clipboard-set ;;
            esac ;;
        e|E) nano $0 ;;
        f|F)
            echo "1.fakeroot 伪装root"
	    echo "2.fuck-u-code 屎山代码检测器"
            read -p "请输入选项：" choice
            case $choice in
                1) pkg install fakeroot -y
                   echo "安装完成"
                   echo "输入fakeroot进入root" ;;
		2) termux-open "https://github.com/Done-0/fuck-u-code" ;;
            esac ;;
        g|G) 
            clear
            echo "1.随机数字"
            read -p "请输入选项：" choice
            case $choice in
                1) 
                    read -p "最小值: " min
                    read -p "最大值: " max
                    range=$(( max - min + 1 ))
                    while :; do
                        printf "%d\n" $(( $(od -An -N4 -tu4 < /dev/urandom | tr -d ' ') % (max - min + 1) + min ))
                        sleep 0.5
                    done ;;
            esac ;;
        p|P) 
            url="https://www.123684.com/s/zy7dvd-VsbKv?pwd=y3lH#"
            termux-open "$url" 2>/dev/null || echo "请手动打开: $url" ;;
        h|H|help) 
            printf "${CYAN}版本：$ver 正式版\n"
            cat <<EOF
电子邮箱：wangxia9@foxmail.com，备用tong689@outlook.com，不懂问我
可能会有某些功能需要安装特定的软件包，缺啥补啥就行
在使用某些功能时，链接可能会失效，麻烦及时反馈给我
作者在此感谢你的使用
EOF
            ;;
        dt|DT) dev_tools ;;
	ad|AD) echo "1.加载函数"
	       read -p "请输入选项：" choice
	       case $choice in
	           1) read -p "请输入函数名：" fn
		      type -t "$fn" &>/dev/null || echo "${BR_RED}ERROR: $fn: 函数不存在" && exit 1
		      eval "$fn" ;;
	       esac ;;
        m|M) menu_settings ;;
        r|R) res_list ;;
        u|U)
            read -p "输入菜单文件的路径：" f
            mv "$f" "$0" && chmod +x "$0" && log "已更新" ;;
#########################################################
        new|NEW) new_menu ;;
	bing|Bing|BING) termux-open $(curl -sL https://60s.viki.moe/v2/bing | jq -r '.data.cover_4k') ;;
	ai|AI)
    while read -p "==> " message; do
        ai_api "$message"
    done
    ;;

        *)
            [ -z "$choice" ] && exit 0
            printf "${BR_RED}ERROR: $choice: 选项未找到${N}\n" ;;
    esac
}

if [[ -n "$func" ]]; then
    if type -t "$func" | grep -q function; then
        eval "$func"
    else
        echo "错误：'$func' 不是有效的函数"
    fi
    exit 0
fi

# 脚本入口
main_menu
###########################################################
# 重复运行脚本提示
for i in 3 2 1; do
    printf "\r${TURQUOISE}按R重新运行，回车退出 还有%d秒…" "$i"
    read -t 1 -s -r -n 1 k || continue
    printf "\r\033[K"
    [[ $k == [rR] ]] && exec "$0"
    exit 0
done
printf "\r\033[K已退出\n"
